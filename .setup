#!/usr/bin/env bash
#
# Modern and optimized xinitrc for X11 session management
# Last updated: May 2025
#

# Source environment variables
[ -f "$HOME/.envvars" ] && source "$HOME/.envvars"

# Define configuration directory
CONFIG_DIR="$HOME/.config"

# Log file for debugging
LOG_FILE="$HOME/.xinitrc.log"
exec > >(tee -a "$LOG_FILE") 2>&1
echo "Starting X session $(date)"

# Function to run commands if not already running
run() {
  local process_name="${1##*/}"
  if ! pgrep -f "$process_name" &>/dev/null; then
    echo "Starting: $*"
    "$@" &
  else
    echo "Already running: $process_name"
  fi
}

# Function to kill processes
kill_process() {
  local pid
  pid=$(pidof "$1" 2>/dev/null)
  if [ -n "$pid" ]; then
    echo "Killing: $1 (PID: $pid)"
    kill -9 "$pid"
  fi
}

# Source X11 system scripts
if [ -d /etc/X11/xinit/xinitrc.d ]; then
  for script in /etc/X11/xinit/xinitrc.d/?*.sh; do
    if [ -x "$script" ]; then
      echo "Sourcing: $script"
      source "$script"
    fi
  done
  unset script
fi

# Kill already running processes that will be restarted
for process in xsettingsd dunst ksuperkey; do
  kill_process "$process"
done

# Initialize dbus if needed
if command -v dbus-launch >/dev/null && [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  echo "Initializing D-Bus session"
  eval "$(dbus-launch --sh-syntax --exit-with-session)"
fi

# Source user profile
[ -f "$HOME/.profile" ] && source "$HOME/.profile"

# Start polkit agent
if ! pidof xfce-polkit &>/dev/null && [ -x /usr/lib/xfce-polkit/xfce-polkit ]; then
  run /usr/lib/xfce-polkit/xfce-polkit
fi

# Set up desktop environment
echo "Setting up desktop environment"

# Background and cursor
[ -f "$HOME/.fehbg" ] && run "$HOME/.fehbg"
run xsetroot -cursor_name left_ptr

# System services and applets
services=(
  "nm-applet"                                         # Network Manager
  "xfsettingsd"                                       # XFCE Settings Daemon
  "blueman-applet"                                    # Bluetooth Manager
  "powertop --auto-tune"                              # Power Optimization
  "picom --config '$CONFIG_DIR/picom.conf' --daemon"  # Compositor
  "xsettingsd --config='$CONFIG_DIR/xsettingsd/xsettingsd.conf'" # X Settings
)

# Launch services in parallel
for service in "${services[@]}"; do
  eval "run $service"
done

# Optional services (uncomment to enable)
# run /usr/lib/kdeconnectd                            # KDE Connect
# run clipmenud                                       # Clipboard Manager
# run redshift -l "$(curl -s "https://location.services.mozilla.com/v1/geolocate?key=geoclue" | jq -r '.location.lat, .location.lng' | tr '\n' ':' | sed 's/:$//')" # Auto location-based screen temperature

echo "X initialization complete"
